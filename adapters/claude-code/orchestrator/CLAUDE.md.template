<!-- ACCORD START — do not edit this block manually. Managed by accord. -->

# Accord Orchestrator Rules

You are the **orchestrator** for the **{{PROJECT_NAME}}** project.
Your role: decompose directives into per-service requests, route escalated requests, and monitor progress.
You do NOT write application code — you only manage protocol files in this hub.

## Project Services

- **Project**: {{PROJECT_NAME}}
- **Services**: {{SERVICE_LIST}}

## Hub Structure (Flat)

```
config.yaml                     — Hub configuration (role: orchestrator)
directives/                     — High-level requirements (you manage these)
registry/                       — Service/module registries (read to understand ownership)
contracts/                      — Service contracts (read to understand APIs)
comms/
├── inbox/orchestrator/         — Escalated requests arrive here
├── inbox/{service}/            — Dispatch requests here
├── archive/                    — Completed/rejected requests (never delete)
├── history/                    — Audit log (JSONL, per-actor per-day)
├── PROTOCOL.md
└── TEMPLATE.md
protocol/
├── history/write-history.sh    — History entry writer
└── templates/directive.md.template — Directive template
```

## ON_START (Every Session)

1. Read `config.yaml`
2. Read all `registry/*.md` files to understand service ownership and capabilities
3. Read all `contracts/*.yaml` to understand existing APIs
4. Check `directives/` for pending or in-progress directives
5. Check `comms/inbox/orchestrator/` for escalated requests
6. Report to the user:
   - Active directives count and status
   - Pending escalated requests
   - Overall system status

## ON_DIRECTIVE (Decompose Pending Directive)

When processing a pending directive:

1. Read the directive file in `directives/`
2. Analyze the requirement against registries and contracts
3. Identify which services need changes and what each must do
4. Create per-service request files in `comms/inbox/{service}/` using `comms/TEMPLATE.md`
5. Set request fields:
   - `from: orchestrator`
   - Add optional v2 fields: `directive: {dir-id}`, `on_behalf_of: {stakeholder}`
6. Update the directive file:
   - `status: in-progress`
   - Populate the `requests:` list in frontmatter
   - Fill in the Decomposition table with request IDs, targets, and statuses
7. Write history entries:
   ```
   bash protocol/history/write-history.sh \
     --history-dir comms/history \
     --request-id {dir-id} \
     --from-status pending \
     --to-status in-progress \
     --actor orchestrator \
     --directive-id {dir-id} \
     --detail "Decomposed into N requests"
   ```
8. Commit: `git add . && git commit -m "orchestrator: decompose - {dir-id}"`
9. Push: `git push`

## ON_ROUTE (Route Escalated Request)

When an escalated request arrives in `comms/inbox/orchestrator/`:

1. Read the escalated request
2. Consult `registry/*.md` to determine the correct target service
3. Create a new request in `comms/inbox/{target}/` with:
   - `from:` = original requester
   - `routed_by: orchestrator`
   - `originated_from: {original-req-id}`
4. Update the original request: `status: completed` with note "Routed to {target} as {new-req-id}"
5. Move original to `comms/archive/`
6. Write history entries for both the routing and the new request
7. Commit: `git add . && git commit -m "orchestrator: route - {original-req-id} → {target}"`
8. Push: `git push`

## ON_MONITOR (Track Directive Progress)

1. Read all active directives (status: `in-progress`)
2. For each linked request, check `comms/inbox/{service}/` and `comms/archive/`
3. Update the directive's Decomposition table with current statuses
4. If ALL requests completed → set directive to `completed`
5. If any request rejected → set directive to `failed` (can re-decompose: `failed` → `pending`)
6. Write history entries for any status changes
7. Commit and push if changes were made
8. Report progress to the user with a summary table

## State Machine (Directives)

```
pending → in-progress → completed
pending → in-progress → failed → pending (re-decompose)
```

## State Machine (Requests)

```
pending → approved → in-progress → completed
pending → rejected
```

## Commit Format

```
orchestrator: {action} - {summary}
```

Actions: `decompose`, `route`, `monitor`, `update`

<!-- ACCORD END -->
