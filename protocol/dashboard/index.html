<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Accord Dashboard</title>
<style>
  :root {
    --bg: #0d1117;
    --surface: #161b22;
    --border: #30363d;
    --text: #c9d1d9;
    --text-muted: #8b949e;
    --accent: #58a6ff;
    --green: #3fb950;
    --red: #f85149;
    --yellow: #d29922;
    --purple: #bc8cff;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding: 24px;
    line-height: 1.5;
  }
  h1 { font-size: 24px; margin-bottom: 8px; }
  h2 { font-size: 18px; margin-bottom: 12px; color: var(--accent); }
  h3 { font-size: 14px; margin-bottom: 8px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }

  .header { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
  .header .status { font-size: 14px; color: var(--text-muted); }

  .controls {
    display: flex; gap: 12px; align-items: center;
    margin-bottom: 24px; padding: 12px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px;
  }
  .controls label { font-size: 13px; color: var(--text-muted); }
  .controls input[type="file"] { font-size: 13px; color: var(--text); }
  .controls button {
    padding: 6px 16px; border: 1px solid var(--border); border-radius: 6px;
    background: var(--surface); color: var(--accent); cursor: pointer; font-size: 13px;
  }
  .controls button:hover { background: var(--border); }

  .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
  .card {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 16px; text-align: center;
  }
  .card .value { font-size: 32px; font-weight: 700; margin: 8px 0 4px; }
  .card .label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
  .card.green .value { color: var(--green); }
  .card.red .value { color: var(--red); }
  .card.yellow .value { color: var(--yellow); }
  .card.accent .value { color: var(--accent); }
  .card.purple .value { color: var(--purple); }

  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px; }
  @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

  .panel {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px;
  }

  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { text-align: left; color: var(--text-muted); font-weight: 600; padding: 8px; border-bottom: 1px solid var(--border); }
  td { padding: 8px; border-bottom: 1px solid var(--border); }
  tr:last-child td { border-bottom: none; }

  .badge {
    display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600;
  }
  .badge.completed { background: rgba(63,185,80,0.15); color: var(--green); }
  .badge.failed { background: rgba(248,81,73,0.15); color: var(--red); }
  .badge.pending { background: rgba(210,153,34,0.15); color: var(--yellow); }
  .badge.in-progress { background: rgba(88,166,255,0.15); color: var(--accent); }

  .bar-chart { display: flex; flex-direction: column; gap: 8px; }
  .bar-row { display: flex; align-items: center; gap: 8px; }
  .bar-label { width: 120px; font-size: 12px; text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .bar-track { flex: 1; height: 24px; background: var(--border); border-radius: 4px; overflow: hidden; display: flex; }
  .bar-fill { height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; min-width: 24px; }
  .bar-fill.completed { background: var(--green); }
  .bar-fill.failed { background: var(--red); }

  .timeline { max-height: 400px; overflow-y: auto; }
  .timeline-entry {
    display: flex; align-items: flex-start; gap: 12px; padding: 8px 0;
    border-bottom: 1px solid var(--border); font-size: 13px;
  }
  .timeline-entry:last-child { border-bottom: none; }
  .timeline-ts { color: var(--text-muted); white-space: nowrap; font-family: monospace; font-size: 12px; min-width: 160px; }
  .timeline-body { flex: 1; }
  .timeline-req { font-weight: 600; color: var(--accent); }
  .timeline-actor { color: var(--purple); }
  .timeline-arrow { color: var(--text-muted); }

  .empty-state { text-align: center; padding: 48px; color: var(--text-muted); }
  .empty-state p { margin-top: 8px; }
</style>
</head>
<body>

<div class="header">
  <h1>Accord Dashboard</h1>
  <span class="status" id="status-text">No data loaded</span>
</div>

<div class="controls">
  <label>Load JSONL history files:</label>
  <input type="file" id="file-input" multiple accept=".jsonl" />
  <button id="btn-load" onclick="loadFiles()">Load</button>
  <button id="btn-demo" onclick="loadDemo()">Load Demo Data</button>
</div>

<div id="content" class="empty-state">
  <h2>No data loaded</h2>
  <p>Select one or more .jsonl history files from your <code>comms/history/</code> directory, or click "Load Demo Data" to preview.</p>
</div>

<script>
// ── State ────────────────────────────────────────────────────────────────────
let allEntries = [];

// ── File loading ─────────────────────────────────────────────────────────────
function loadFiles() {
  const input = document.getElementById('file-input');
  if (!input.files || input.files.length === 0) return;

  allEntries = [];
  let loaded = 0;
  for (const file of input.files) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const lines = e.target.result.split('\n').filter(l => l.trim());
      for (const line of lines) {
        try { allEntries.push(JSON.parse(line)); } catch {}
      }
      loaded++;
      if (loaded === input.files.length) {
        allEntries.sort((a, b) => new Date(a.ts).getTime() - new Date(b.ts).getTime());
        render();
      }
    };
    reader.readAsText(file);
  }
}

function loadDemo() {
  const now = new Date();
  const entries = [];
  const services = ['auth-service', 'user-service', 'payment-service', 'api-gateway'];
  const statuses = ['completed', 'completed', 'completed', 'failed', 'completed', 'completed'];

  for (let i = 0; i < 24; i++) {
    const ts = new Date(now.getTime() - (24 - i) * 3600000);
    const svc = services[i % services.length];
    const toStatus = statuses[i % statuses.length];
    entries.push({
      ts: ts.toISOString(),
      request_id: `req-${String(i + 1).padStart(3, '0')}-demo`,
      from_status: 'in-progress',
      to_status: toStatus,
      actor: svc,
      duration_ms: Math.floor(Math.random() * 180000) + 5000,
      cost_usd: parseFloat((Math.random() * 0.5 + 0.01).toFixed(4)),
      num_turns: Math.floor(Math.random() * 30) + 3,
    });
  }
  allEntries = entries;
  render();
}

// ── Aggregation ──────────────────────────────────────────────────────────────
function aggregate(entries) {
  const metrics = {
    total: 0, completed: 0, failed: 0,
    avgLatencyMs: 0, totalCostUsd: 0, successRate: 0,
    totalTurns: 0, turnsCount: 0,
    byService: {},
  };

  let totalLatency = 0, latencyCount = 0;

  for (const e of entries) {
    if (e.to_status !== 'completed' && e.to_status !== 'failed') continue;
    metrics.total++;

    const svc = e.actor || 'unknown';
    if (!metrics.byService[svc]) {
      metrics.byService[svc] = { total: 0, completed: 0, failed: 0, totalLatency: 0, latencyCount: 0, totalCost: 0, totalTurns: 0 };
    }
    const s = metrics.byService[svc];
    s.total++;

    if (e.to_status === 'completed') {
      metrics.completed++;
      s.completed++;
    } else {
      metrics.failed++;
      s.failed++;
    }

    if (e.duration_ms !== undefined) {
      totalLatency += e.duration_ms;
      latencyCount++;
      s.totalLatency += e.duration_ms;
      s.latencyCount++;
    }
    if (e.cost_usd !== undefined) {
      metrics.totalCostUsd += e.cost_usd;
      s.totalCost += e.cost_usd;
    }
    if (e.num_turns !== undefined) {
      metrics.totalTurns += e.num_turns;
      metrics.turnsCount++;
      s.totalTurns += e.num_turns;
    }
  }

  if (latencyCount > 0) metrics.avgLatencyMs = totalLatency / latencyCount;
  if (metrics.total > 0) metrics.successRate = metrics.completed / metrics.total;

  return metrics;
}

// ── Rendering ────────────────────────────────────────────────────────────────
function render() {
  const m = aggregate(allEntries);
  document.getElementById('status-text').textContent = `${allEntries.length} history entries loaded`;

  const content = document.getElementById('content');
  content.className = '';
  content.innerHTML = '';

  // Summary cards
  const cardsHtml = `
    <div class="cards">
      <div class="card accent"><div class="label">Total Requests</div><div class="value">${m.total}</div></div>
      <div class="card green"><div class="label">Completed</div><div class="value">${m.completed}</div></div>
      <div class="card red"><div class="label">Failed</div><div class="value">${m.failed}</div></div>
      <div class="card green"><div class="label">Success Rate</div><div class="value">${(m.successRate * 100).toFixed(1)}%</div></div>
      <div class="card yellow"><div class="label">Avg Latency</div><div class="value">${formatDuration(m.avgLatencyMs)}</div></div>
      <div class="card purple"><div class="label">Total Cost</div><div class="value">$${m.totalCostUsd.toFixed(2)}</div></div>
    </div>
  `;

  // Per-service breakdown
  const serviceNames = Object.keys(m.byService).sort();
  const maxTotal = Math.max(...serviceNames.map(s => m.byService[s].total), 1);

  let barHtml = '';
  for (const svc of serviceNames) {
    const s = m.byService[svc];
    const completedPct = (s.completed / maxTotal) * 100;
    const failedPct = (s.failed / maxTotal) * 100;
    const avgLat = s.latencyCount > 0 ? formatDuration(s.totalLatency / s.latencyCount) : '-';
    barHtml += `
      <div class="bar-row">
        <div class="bar-label" title="${svc}">${svc}</div>
        <div class="bar-track">
          <div class="bar-fill completed" style="width:${completedPct}%">${s.completed}</div>
          ${s.failed > 0 ? `<div class="bar-fill failed" style="width:${failedPct}%">${s.failed}</div>` : ''}
        </div>
      </div>
    `;
  }

  // Service table
  let tableRows = '';
  for (const svc of serviceNames) {
    const s = m.byService[svc];
    const avgLat = s.latencyCount > 0 ? formatDuration(s.totalLatency / s.latencyCount) : '-';
    const avgTurns = s.totalTurns > 0 ? (s.totalTurns / s.total).toFixed(1) : '-';
    const cost = s.totalCost > 0 ? '$' + s.totalCost.toFixed(2) : '-';
    const rate = s.total > 0 ? (s.completed / s.total * 100).toFixed(0) + '%' : '-';
    tableRows += `<tr>
      <td>${svc}</td>
      <td>${s.total}</td>
      <td>${s.completed}</td>
      <td>${s.failed}</td>
      <td>${rate}</td>
      <td>${avgLat}</td>
      <td>${avgTurns}</td>
      <td>${cost}</td>
    </tr>`;
  }

  // Timeline (most recent first)
  const terminal = allEntries.filter(e => e.to_status === 'completed' || e.to_status === 'failed');
  const recent = [...terminal].reverse().slice(0, 50);
  let timelineHtml = '';
  for (const e of recent) {
    const badge = e.to_status === 'completed' ? 'completed' : 'failed';
    const dur = e.duration_ms !== undefined ? ` (${formatDuration(e.duration_ms)})` : '';
    const cost = e.cost_usd !== undefined ? ` &middot; $${e.cost_usd.toFixed(4)}` : '';
    timelineHtml += `
      <div class="timeline-entry">
        <span class="timeline-ts">${formatTimestamp(e.ts)}</span>
        <span class="badge ${badge}">${e.to_status}</span>
        <div class="timeline-body">
          <span class="timeline-req">${e.request_id}</span>
          <span class="timeline-arrow">&rarr;</span>
          <span class="timeline-actor">${e.actor}</span>
          <span style="color:var(--text-muted)">${dur}${cost}</span>
        </div>
      </div>
    `;
  }

  content.innerHTML = `
    ${cardsHtml}
    <div class="grid">
      <div class="panel">
        <h3>Requests by Service</h3>
        <div class="bar-chart">${barHtml || '<p style="color:var(--text-muted)">No data</p>'}</div>
      </div>
      <div class="panel">
        <h3>Service Details</h3>
        <table>
          <thead><tr><th>Service</th><th>Total</th><th>OK</th><th>Fail</th><th>Rate</th><th>Avg Lat</th><th>Avg Turns</th><th>Cost</th></tr></thead>
          <tbody>${tableRows || '<tr><td colspan="8" style="text-align:center;color:var(--text-muted)">No data</td></tr>'}</tbody>
        </table>
      </div>
    </div>
    <div class="panel">
      <h3>Recent Activity (last 50)</h3>
      <div class="timeline">${timelineHtml || '<p style="color:var(--text-muted)">No activity</p>'}</div>
    </div>
  `;
}

// ── Helpers ──────────────────────────────────────────────────────────────────
function formatDuration(ms) {
  if (!ms || ms <= 0) return '-';
  if (ms < 1000) return ms.toFixed(0) + 'ms';
  if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
  const min = Math.floor(ms / 60000);
  const sec = Math.floor((ms % 60000) / 1000);
  return min + 'm' + (sec > 0 ? sec + 's' : '');
}

function formatTimestamp(ts) {
  try {
    const d = new Date(ts);
    return d.toLocaleString('en-US', {
      month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false,
    });
  } catch { return ts; }
}
</script>
</body>
</html>
