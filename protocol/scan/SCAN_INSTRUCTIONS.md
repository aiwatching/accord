# Contract Scanner Instructions

Version: 0.1.0-draft

This document defines the agent-agnostic instructions for automatically scanning source code and generating Accord contract files. Any AI coding agent can follow these instructions — they are not specific to any tool.

---

## 1. Overview

The Contract Scanner analyzes source code within a service or module and generates:
- **External contracts** (`.accord/contracts/{service}.yaml`): OpenAPI specs for REST/RPC endpoints
- **Internal contracts** (`.accord/contracts/internal/{module}.md`): Code-level interface definitions

Generated contracts are marked with `status: draft` and require human review before becoming `stable`.

---

## 2. When to Scan

- During `accord init` for a new service
- When a user explicitly requests contract generation (`accord scan`)
- After major refactoring that changes public interfaces
- When onboarding an existing codebase into Accord

---

## 3. External Contract Scanning (REST API)

### 3.1 Detection Rules by Language

| Language/Framework | What to Look For |
|-------------------|-----------------|
| Java / Spring Boot | `@RestController`, `@RequestMapping`, `@GetMapping`, `@PostMapping`, `@PutMapping`, `@DeleteMapping`, `@PatchMapping` |
| Python / FastAPI | `@app.get`, `@app.post`, `@app.put`, `@app.delete`, `@router.get`, etc. |
| Python / Flask | `@app.route`, `@blueprint.route` |
| TypeScript / Express | `router.get()`, `router.post()`, `app.get()`, `app.post()` |
| Go / net/http | `http.HandleFunc()`, `mux.HandleFunc()` |
| Go / Gin | `router.GET()`, `router.POST()`, `group.GET()`, etc. |

### 3.2 What to Extract per Endpoint

For each detected endpoint, extract:

1. **HTTP method** (GET, POST, PUT, DELETE, PATCH)
2. **Path** (including path parameters)
3. **Request parameters**: query params, path params, request body type
4. **Response type**: return type / response body structure
5. **Description**: from annotations, decorators, or doc comments
6. **Error responses**: documented error codes and types

### 3.3 Output Format

Generate a valid OpenAPI 3.0+ YAML file at `.accord/contracts/{service-name}.yaml`:

```yaml
openapi: "3.0.3"
info:
  title: "{service-name} API"
  version: "draft"
  x-accord-status: draft          # Generated by accord scan, needs review
  x-accord-scanned: "{ISO-8601 timestamp}"

paths:
  /api/{resource}/{id}:
    get:
      summary: "..."
      parameters: [...]
      responses:
        '200':
          description: "..."
          content:
            application/json:
              schema: { ... }
```

### 3.4 Rules

- If a contract file already exists, **do not overwrite**. Instead, output a diff or append `x-accord-status: proposed` to new endpoints only.
- Mark all generated content with `x-accord-status: draft`.
- Include a `components/schemas` section for all referenced DTOs/models.
- Preserve any existing manually-written content in the contract file.

---

## 4. Internal Contract Scanning (Module Interfaces)

### 4.1 Detection Rules by Language

| Language | What to Look For |
|---------|-----------------|
| Java | `public interface` that is imported by classes in **other** packages/modules. Also: `public abstract class` used as an SPI. |
| Python | Classes extending `Protocol` (typing) or `ABC` (abc module) that are imported by other modules. |
| TypeScript | `export interface` or `export type` that are imported by other module directories. |
| Go | `type XXX interface` in a package that is imported by other packages within the service. |

### 4.2 What to Extract per Interface

1. **Interface/class name**
2. **Method signatures**: name, parameters (with types), return type
3. **Behavioral notes**: from JavaDoc, docstrings, or comments — thread-safety, idempotency, ordering guarantees, exception behavior
4. **Used by**: which other modules import/depend on this interface

### 4.3 Filtering: What to Include vs Exclude

**Include** (these are the cross-module boundary interfaces):
- Public interfaces/protocols/ABCs imported by other modules
- Factory or registry patterns that multiple modules depend on
- Event/callback interfaces used for cross-module communication

**Exclude** (these are internal implementation details):
- Interfaces only used within the same module/package
- Private/package-private classes
- Utility classes, DTOs that don't represent a module boundary
- Test classes and test utilities

### 4.4 Output Format

Generate a markdown file at `.accord/contracts/internal/{module-name}.md`:

```markdown
---
id: {module-name}
module: {module-name}
language: {java|python|typescript|go}
type: interface
status: draft
x-accord-scanned: "{ISO-8601 timestamp}"
---

## Interface

```{language}
// Extracted interface signatures here
```

## Behavioral Contract
- [Extracted from doc comments, or marked as TODO if not documented]

## Used By
- [List of modules that import this interface]
```

### 4.5 Rules

- If an internal contract already exists, **do not overwrite**. Generate a separate `{module-name}.draft.md` for comparison.
- Only include interfaces that cross module boundaries (see 4.3).
- Mark behavioral contracts as `TODO: document` if no doc comments exist.
- One contract file per module, even if the module exposes multiple interfaces.

---

## 5. Invocation

### 5.1 CLI Entry Point

```bash
# Scan a service for external API contracts
accord scan --service {service-name} --type external

# Scan a service for internal module contracts
accord scan --service {service-name} --type internal

# Scan both
accord scan --service {service-name} --type all

# Scan all services in the project
accord scan --all
```

### 5.2 What the Script Does

`accord scan` is a **prompt generator + output validator**:

1. **Determine scope**: Read `.accord/config.yaml` to find service directories and modules
2. **Generate prompt**: Build a scanning prompt from this document's rules (Section 3 or 4)
3. **Present to agent**: Output the prompt for the current agent to execute, OR if running standalone, print file paths to scan
4. **Validate output**: After the agent generates contracts, run validators to check format compliance

### 5.3 Agent-Assisted Mode (MVP)

In the MVP, `accord scan` generates a structured prompt that the current agent executes:

```
Scan all files in {service-dir}/src/
Following the rules in protocol/scan/SCAN_INSTRUCTIONS.md:
1. Identify all {external endpoints | module interfaces}
2. Generate contract files in the Accord format
3. Mark all generated contracts with status: draft
```

The agent uses its own AI capabilities to analyze the code — no AST parser required.

---

## 6. Post-Scan Workflow

After scanning:

1. Generated contracts have `status: draft`
2. Developer reviews the generated contracts
3. Developer changes status to `stable` (or edits and then marks stable)
4. Commit: `contract({service}): scan - initial contract generation`
5. Other services/modules can now reference these contracts

---

## 7. Validation

### 7.1 External Contract Validation

- Must be valid OpenAPI 3.0+ YAML (parseable by any OpenAPI validator)
- Must have `info.title` and `info.version`
- All `$ref` references must resolve
- All paths must have at least one operation

### 7.2 Internal Contract Validation

- Must have valid YAML frontmatter with required fields: `id`, `module`, `language`, `type`, `status`
- Must have `## Interface` section with a code block
- Must have `## Behavioral Contract` section (can contain TODOs)
- Must have `## Used By` section with at least one entry
